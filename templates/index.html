{% extends "base.html" %}

{% block content %}
<div class="layout-wrapper" style="display: grid; grid-template-columns: 240px 1fr; gap: 2rem; align-items: start;">

  <aside class="sidebar">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3 style="margin:0;">Views</h3>
    </div>
    <ul class="view-list" style="list-style:none; padding:0; margin: 1rem 0;">
      <li style="margin-bottom:0.5rem;">
        <a href="{{ url_for('index') }}" class="btn-secondary" style="display:block; text-align:left; {% if not request.query_string %}font-weight:bold; border-color:#666;{% endif %}">
          All Prompts
        </a>
      </li>
      {% for view in saved_views %}
        <li style="margin-bottom:0.5rem; display:flex; gap:0.25rem;">
          <a href="/?{{ view.query_params }}" class="btn-secondary" style="display:block; flex:1; text-align:left; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">{{ view.name }}</a>
          <form method="post" action="{{ url_for('delete_view', view_id=view.id) }}" onsubmit="return confirm('Delete view?');">
            <button type="submit" style="padding: 0.5rem; font-size: 0.8em;">&times;</button>
          </form>
        </li>
      {% endfor %}
    </ul>
    <hr style="border-color:#333;">
    <form method="post" action="{{ url_for('save_view') }}" style="margin-top:1rem;">
      <input type="hidden" name="query_string" value="{{ request.query_string.decode() }}">
      <label style="font-size:0.85em;">Save current filters as:</label>
      <div style="display:flex; gap:0.25rem; margin-top:0.25rem;">
        <input type="text" name="view_name" placeholder="e.g. Portrait Flux" required style="width:100%; font-size:0.9em;">
        <button type="submit" style="padding:0 0.5rem;">+</button>
      </div>
    </form>
  </aside>

  <section style="min-width:0;">

    {% if view_family %}
    <div style="background:#222; padding:1rem; border-radius:8px; margin-bottom:1.5rem; display:flex; justify-content:space-between; align-items:center; border-left:4px solid #00bfff;">
        <h3 style="margin:0;">ðŸ“‚ Viewing Prompt Family</h3>
        <a href="{{ url_for('index') }}" class="btn-secondary">Back to Full Library</a>
    </div>
    {% endif %}

    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:1rem; margin-bottom:1rem;">
      <h2 style="margin:0;">Library</h2>
      <div style="display:flex; gap:0.5rem;">
         <a class="btn-secondary" href="{{ url_for('new_prompt') }}">New Prompt</a>
         <a class="btn-secondary" href="{{ url_for('import_prompt') }}">Import</a>
         <a class="btn-secondary" href="{{ url_for('import_db_page') }}">Merge DB</a>
         <button type="button" class="btn-secondary" id="toggleOrganise">Select / Export</button>
      </div>
    </div>

    <form method="get" class="filters" id="filterForm" style="background:#1a1a1a; padding:1rem; border-radius:8px; margin-bottom:1.5rem;">
      <div style="display:flex; gap:0.75rem; flex-wrap:wrap;">
        <div style="flex:1; min-width:180px;">
          <input type="text" name="q" value="{{ q|default('') }}" placeholder="Search..." style="width:100%;">
        </div>
        <div style="flex:1; min-width:180px;">
          <input type="text" name="q_not" value="{{ q_not|default('') }}" placeholder="Exclude..." style="width:100%; border-color:#d32f2f;">
        </div>

        <select name="category">
          <option value="all">All Categories</option>
          {% for c in categories %}
            <option value="{{ c }}" {% if active_category == c %}selected{% endif %}>{{ c }}</option>
          {% endfor %}
        </select>

        <select name="tool">
          <option value="all">All Tools</option>
          {% for t in tools %}
            <option value="{{ t }}" {% if active_tool == t %}selected{% endif %}>{{ t }}</option>
          {% endfor %}
        </select>

        <select name="group">
          <option value="all">All Groups</option>
          {% for g in groups %}
            <option value="{{ g.id }}" {% if active_group|string == g.id|string %}selected{% endif %}>{{ g.name }}</option>
          {% endfor %}
        </select>

        <select name="tag">
          <option value="all">All Tags</option>
          {% for t in all_tags %}
            <option value="{{ t }}" {% if active_tag == t %}selected{% endif %}>{{ t }}</option>
          {% endfor %}
        </select>

        <button type="submit">Filter</button>
        {% if q or q_not or active_category!='all' or active_tool!='all' or active_group!='all' or active_tag!='all' %}
          <a href="{{ url_for('index') }}" style="align-self:center; font-size:0.9em; margin-left:0.5rem;">Clear</a>
        {% endif %}
      </div>
      <input type="hidden" name="sort_by" value="{{ sort_by|default('updated_at') }}">
      <input type="hidden" name="sort_dir" value="{{ sort_dir|default('desc') }}">
    </form>

    <div id="organisePanel" style="display:none; margin-bottom:1.5rem; padding:1rem; border:1px solid #333; border-radius:10px;">
        <h3 style="margin-top:0;">Organise & Export</h3>
        <form method="post" action="{{ url_for('bulk_update') }}" id="bulkForm">
            <div class="grid" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:0.75rem;">
               <div>
                 <label>Category</label>
                 <input list="cat_list" name="bulk_category" placeholder="(no change)">
                 <datalist id="cat_list">{% for c in categories %}<option value="{{ c }}">{% endfor %}</datalist>
               </div>
               <div>
                 <label>Tool</label>
                 <input list="tool_list" name="bulk_tool" placeholder="(no change)">
                 <datalist id="tool_list">{% for t in tools %}<option value="{{ t }}">{% endfor %}</datalist>
               </div>
               <div>
                 <label>Group</label>
                 <select name="bulk_group">
                   <option value="">(no change)</option>
                   <option value="none">(remove from group)</option>
                   {% for g in groups %}
                     <option value="{{ g.id }}">{{ g.name }}</option>
                   {% endfor %}
                 </select>
               </div>
               <div>
                 <label>Add Tags</label>
                 <input type="text" name="bulk_tags" placeholder="e.g. vibrant, 8k (appends)">
               </div>
            </div>
            <div style="margin-top:1rem; display:flex; justify-content:space-between; align-items:center;">
                <div style="display:flex; gap:0.5rem;">
                    <button type="button" class="btn-secondary" id="selectAll">Select All</button>
                    <button type="button" class="btn-secondary" id="selectNone">Select None</button>
                </div>
                <div style="display:flex; gap:0.5rem;">
                    <button type="submit" class="btn-primary" style="background:#51cf66; border-color:#51cf66;">Apply Changes</button>
                    <button type="submit" formaction="{{ url_for('export_selected') }}" class="btn-primary" style="background:#00bfff; border-color:#00bfff;">Export Selected</button>
                </div>
            </div>
        </form>
    </div>

    <ul class="prompt-list" id="promptList">
      {% include "_prompt_cards.html" %}
    </ul>

    <div id="infiniteScrollControls" style="display:none; text-align:center; margin-top:1rem;">
      <div id="scrollLoading" style="display:none; opacity:0.7;">Loadingâ€¦</div>
      <div id="scrollEnd" style="display:none; opacity:0.7;">No more results.</div>
    </div>
    <div id="scrollSentinel" style="height:1px;"></div>

    {% if total_pages > 1 %}
    <div id="paginationControls">
      <div style="margin-top:2rem; display:flex; justify-content:center; gap:0.5rem;">
        {% if page > 1 %}
          <a class="btn-secondary" href="{{ url_for('index', page=page-1, q=q, q_not=q_not, view_family=view_family, category=active_category, tool=active_tool, group=active_group, tag=active_tag, sort_by=sort_by, sort_dir=sort_dir) }}">&laquo; Prev</a>
        {% else %}
          <span class="btn-secondary" style="opacity:0.5; cursor:default;">&laquo; Prev</span>
        {% endif %}

        <span style="padding:0.5rem;">Page {{ page }} of {{ total_pages }}</span>

        {% if page < total_pages %}
          <a class="btn-secondary" href="{{ url_for('index', page=page+1, q=q, q_not=q_not, view_family=view_family, category=active_category, tool=active_tool, group=active_group, tag=active_tag, sort_by=sort_by, sort_dir=sort_dir) }}">Next &raquo;</a>
        {% else %}
          <span class="btn-secondary" style="opacity:0.5; cursor:default;">Next &raquo;</span>
        {% endif %}
      </div>
    </div>
    {% endif %}

  </section>
</div>

<style>
  .drop-zone { position: relative; transition: border-color 0.2s; }
  .drop-zone.drag-over { border: 2px dashed #00bfff; }
  .drop-overlay { display: none; position: absolute; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.6); color: white; justify-content: center; align-items: center; font-weight: bold; z-index: 5; border-radius: 8px; pointer-events: none; }
  .drop-zone.drag-over .drop-overlay { display: flex; }
  .thumb-placeholder { width: 100%; height: 160px; background: #222; display: flex; align-items: center; justify-content: center; font-size: 3rem; color: #444; }
  .card-thumb-area { position: relative; height: 160px; overflow: hidden; background: #000; display: flex; align-items: center; justify-content: center; }
  .card-thumb-area img { width: 100%; height: 100%; object-fit: contain; }
</style>

<script>
function togglePreview(id){
  const el = document.getElementById(`preview-${id}`);
  if(el) el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

function copyPrompt(id){
  const el = document.querySelector(`#preview-${id} pre`);
  if(el) {
      navigator.clipboard.writeText(el.innerText);
      const btn = event.target;
      const originalText = btn.textContent;
      btn.textContent = "Copied!";
      setTimeout(() => btn.textContent = originalText, 1500);
  } else {
      alert("Please open the preview first to copy the text.");
  }
}

document.addEventListener('DOMContentLoaded', () => {
    const toggle = document.getElementById('toggleOrganise');
    const panel = document.getElementById('organisePanel');
    const btnAll = document.getElementById('selectAll');
    const btnNone = document.getElementById('selectNone');

    let orgMode = false;

    function getCheckWrappers() {
      return document.querySelectorAll('.organise-checkbox');
    }

    function applyOrganiseMode() {
      if (panel) panel.style.display = orgMode ? 'block' : 'none';
      getCheckWrappers().forEach(c => c.style.display = orgMode ? 'block' : 'none');
      if (toggle) toggle.textContent = orgMode ? 'Close Organise' : 'Organise';
    }

    if (toggle) {
      toggle.addEventListener('click', () => {
        orgMode = !orgMode;
        applyOrganiseMode();
      });
    }

    if (btnAll) btnAll.addEventListener('click', () => {
      getCheckWrappers().forEach(c => {
        const i = c.querySelector('input');
        if (i) i.checked = true;
      });
    });

    if (btnNone) btnNone.addEventListener('click', () => {
      getCheckWrappers().forEach(c => {
        const i = c.querySelector('input');
        if (i) i.checked = false;
      });
    });

    // ---- Drag & Drop Thumb Upload ----
    const zones = document.querySelectorAll('.drop-zone');
    zones.forEach(zone => {
        zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('drag-over'); });
        zone.addEventListener('dragleave', () => { zone.classList.remove('drag-over'); });
        zone.addEventListener('drop', (e) => {
            e.preventDefault(); zone.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) handleUpload(zone.dataset.id, files[0], zone);
        });
    });

    function handleUpload(id, file, zoneElement) {
        if (!file.type.startsWith('image/')) { alert("Please drop an image file."); return; }
        const formData = new FormData();
        formData.append('file', file);

        const overlay = zoneElement.querySelector('.drop-overlay');
        overlay.style.display = 'flex'; overlay.textContent = 'Uploading...';

        fetch(`/api/prompt/${id}/upload_thumb`, { method: 'POST', body: formData })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                let img = zoneElement.querySelector('img.thumb');
                if (!img) {
                    const container = zoneElement.querySelector('.card-thumb-area');
                    container.innerHTML = '<img class="thumb" alt="Thumbnail">';
                    img = container.querySelector('img');
                }
                img.src = data.thumbnail_url + '?t=' + new Date().getTime();
            } else {
                alert('Upload failed: ' + data.error);
            }
        })
        .catch(err => alert('Error: ' + err))
        .finally(() => { overlay.style.display = 'none'; overlay.textContent = ''; });
    }

    // -------------------------
    // Infinite Scroll (HTML partial append)
    // -------------------------
    const promptList = document.getElementById('promptList');
    const sentinel = document.getElementById('scrollSentinel');
    const controls = document.getElementById('infiniteScrollControls');
    const loadingEl = document.getElementById('scrollLoading');
    const endEl = document.getElementById('scrollEnd');
    const paginationControls = document.getElementById('paginationControls');

    if (promptList && sentinel && ('IntersectionObserver' in window)) {
      if (paginationControls) paginationControls.style.display = 'none';
      if (controls) controls.style.display = 'block';

      let nextPage = Number({{ page|int }}) + 1;
      let isLoading = false;
      let hasMore = true;

      function setLoading(on) {
        if (!loadingEl) return;
        loadingEl.style.display = on ? 'block' : 'none';
      }

      function showEnd() {
        if (endEl) endEl.style.display = 'block';
      }

      function bindDropZones(root=document) {
        const zones2 = root.querySelectorAll('.drop-zone');
        zones2.forEach(zone => {
          if (zone.dataset.dndBound === "1") return;
          zone.dataset.dndBound = "1";

          zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('drag-over'); });
          zone.addEventListener('dragleave', () => { zone.classList.remove('drag-over'); });
          zone.addEventListener('drop', (e) => {
            e.preventDefault(); zone.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files && files.length > 0) handleUpload(zone.dataset.id, files[0], zone);
          });
        });
      }

      bindDropZones(document);

      async function loadNextPage() {
        if (!hasMore || isLoading) return;
        isLoading = true;
        setLoading(true);

        try {
          const params = new URLSearchParams(window.location.search);
          params.set('page', String(nextPage));

          const res = await fetch(`/api/prompts?${params.toString()}`, {
            headers: { 'Accept': 'application/json' }
          });

          if (!res.ok) throw new Error(`HTTP ${res.status}`);

          const data = await res.json();
          const html = (data.html || "").trim();

          if (html) {
            promptList.insertAdjacentHTML('beforeend', html);
            bindDropZones(promptList);

            // KEY FIX: when new cards are appended, ensure organise mode applies to them too
            applyOrganiseMode();
          }

          hasMore = !!data.has_more;
          if (hasMore && data.next_page) {
            nextPage = data.next_page;
          } else {
            showEnd();
          }
        } catch (err) {
          console.error(err);
          hasMore = false;
        } finally {
          isLoading = false;
          setLoading(false);
        }
      }

      const io = new IntersectionObserver((entries) => {
        const hit = entries.some(e => e.isIntersecting);
        if (hit) loadNextPage();
      }, { rootMargin: '800px 0px' });

      io.observe(sentinel);
    }

    // Ensure initial state is consistent (especially if server rendered organise panel visible/hidden)
    applyOrganiseMode();
});
</script>

{% endblock %}
