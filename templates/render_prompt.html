{% extends "base.html" %}

{% block content %}
<section class="page" style="max-width: 800px; margin: 0 auto;">
  
  <div class="page-header" style="margin-bottom: 2rem;">
    <div>
        <h2 style="margin:0;">Use Prompt</h2>
        <h3 style="margin:0; opacity: 0.6; font-weight: normal;">{{ prompt.title }}</h3>
    </div>
    <a class="btn-secondary" href="{{ url_for('index') }}">Back to Library</a>
  </div>

  {% if placeholders %}
  <div style="background:#1a1a1a; padding:1.5rem; border-radius:8px; margin-bottom:2rem; border:1px solid #333;">
      <h4 style="margin-top:0; color:#00bfff; margin-bottom:1rem;">Variables</h4>
      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:1rem;">
          {% for name in placeholders %}
          <div>
              <label style="font-size:0.85em; text-transform:uppercase; letter-spacing:1px; opacity:0.7;">{{ name }}</label>
              <input type="text" class="placeholder-input" data-target="{{ name }}" oninput="updateFinal()" placeholder="Value for {{ name }}..." style="width:100%;">
          </div>
          {% endfor %}
      </div>
  </div>
  {% endif %}

  <form action="{{ url_for('refine_prompt', prompt_id=prompt.id) }}" method="POST">
      
      <div style="display:flex; justify-content:space-between; align-items:end; margin-bottom:0.5rem;">
          <label>Final Prompt (Editable)</label>
          <span id="copyFeedback" style="font-size:0.85em; color:#51cf66; opacity:0; transition:opacity 0.3s;">Copied!</span>
      </div>

      <textarea id="templateSource" style="display:none;">{{ prompt.content }}</textarea>

      <textarea name="content" id="finalOutput" rows="12" style="font-family:monospace; line-height:1.5; font-size:1.1em; padding:1rem;">{{ prompt.content }}</textarea>

      <div class="action-bar" style="margin-top:1rem; display:flex; gap:1rem; flex-wrap:wrap;">
          <button type="button" class="btn-primary" onclick="copyToClipboard()" style="flex:2;">
              Copy to Clipboard
          </button>

          <button type="submit" class="btn-secondary" style="flex:1;" title="Send this text to Ollama for refinement">
              âœ¨ Refine with Ollama
          </button>
      </div>
  </form>

</section>

<script>
// 1. LIVE UPDATE FUNCTION
function updateFinal() {
    let text = document.getElementById('templateSource').value;
    const inputs = document.querySelectorAll('.placeholder-input');
    
    // Loop through all placeholder inputs
    inputs.forEach(input => {
        const key = input.getAttribute('data-target');
        const val = input.value;
        
        // Replace all instances of [[key]] with the value (or keep [[key]] if empty)
        // We use a RegExp with 'g' (global) flag to replace multiple occurrences
        if(val) {
            const regex = new RegExp(`\\[\\[${key}\\]\\]`, 'g');
            text = text.replace(regex, val);
        }
    });

    document.getElementById('finalOutput').value = text;
}

// 2. COPY FUNCTION
function copyToClipboard() {
    const text = document.getElementById('finalOutput').value;
    navigator.clipboard.writeText(text).then(() => {
        const feedback = document.getElementById('copyFeedback');
        feedback.style.opacity = '1';
        setTimeout(() => feedback.style.opacity = '0', 2000);
    });
}
</script>
{% endblock %}