{% extends "base.html" %}

{% block content %}
<section class="page" style="max-width: 800px; margin: 0 auto;">
  
  <div class="page-header" style="margin-bottom: 1rem;">
    <div>
        <h2 style="margin:0;">Use Prompt</h2>
        <h3 style="margin:0; opacity: 0.6; font-weight: normal;">{{ prompt.title }}</h3>
    </div>
    <a class="btn-secondary" href="{{ url_for('index') }}">Back to Library</a>
  </div>

  {% if variants and variants|length > 1 %}
  <div style="margin-bottom: 2rem; background: #111; padding: 0.75rem; border-radius: 8px; border: 1px solid #333; display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap;">
      <span style="font-size:0.85em; text-transform:uppercase; color:#666; font-weight:bold; margin-right:0.5rem;">Variants:</span>
      
      {% for v in variants %}
        <a href="{{ url_for('render_prompt', prompt_id=v.id) }}" 
           style="text-decoration:none; padding: 0.3rem 0.8rem; border-radius: 4px; font-size: 0.9em; transition: all 0.2s; 
                  {% if v.id == prompt.id %}
                    background: #00bfff; color: #000; font-weight: bold; cursor: default;
                  {% else %}
                    background: #333; color: #ccc;
                  {% endif %}">
           {{ v.title }}
        </a>
      {% endfor %}
  </div>
  {% endif %}

  {% if prompt.notes %}
  <details style="background: #252525; border-left: 4px solid #00bfff; border-radius: 4px; margin-bottom: 2rem;">
      <summary style="padding: 0.75rem 1rem; cursor: pointer; color: #fff; font-weight: bold; font-size: 0.95em; user-select: none;">
          üìù Notes & Instructions (Click to toggle)
      </summary>
      <div style="padding: 0 1rem 1rem 1rem; color: #ddd; font-size: 0.95em; white-space: pre-wrap; line-height: 1.5; border-top: 1px solid #333; margin-top: 0.25rem; padding-top: 0.75rem;">{{ prompt.notes }}</div>
  </details>
  {% endif %}

  {% if placeholders %}
  <div style="background:#1a1a1a; padding:1.5rem; border-radius:8px; margin-bottom:2rem; border:1px solid #333;">
      <h4 style="margin-top:0; color:#00bfff; margin-bottom:1rem;">Variables</h4>
      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:1rem;">
          {% for name in placeholders %}
          <div>
              <label style="font-size:0.85em; text-transform:uppercase; letter-spacing:1px; opacity:0.7;">{{ name }}</label>
              <input type="text" class="placeholder-input" data-target="{{ name }}" oninput="updateFinal()" placeholder="Value for {{ name }}..." style="width:100%;">
          </div>
          {% endfor %}
      </div>
  </div>
  {% endif %}

  <form action="{{ url_for('refine_prompt', prompt_id=prompt.id) }}" method="POST">
      
      <div style="display:flex; justify-content:space-between; align-items:end; margin-bottom:0.5rem;">
          <label>Final Prompt (Editable)</label>
          <span id="copyFeedback" style="font-size:0.85em; color:#51cf66; opacity:0; transition:opacity 0.3s;">Copied!</span>
      </div>

      <textarea id="templateSource" style="display:none;">{{ final_text or prompt.content }}</textarea>
      <textarea name="content" id="finalOutput" rows="12" style="font-family:monospace; line-height:1.5; font-size:1.1em; padding:1rem;">{{ final_text or prompt.content }}</textarea>

      <div class="action-bar" style="margin-top:1rem; display:flex; gap:1rem; flex-wrap:wrap;">
          <button type="button" class="btn-primary" onclick="copyToClipboard()" style="flex:2;">Copy to Clipboard</button>

          <button type="submit" class="btn-secondary" style="flex:1;" title="Send this text to Ollama for refinement">‚ú® Refine with Ollama</button>

          <button type="submit" class="btn-secondary" style="flex:1;" name="save_mode" value="overwrite"
                  formaction="{{ url_for('save_from_use', prompt_id=prompt.id) }}"
                  title="Overwrite the saved prompt content with the text above">üíæ Save</button>

          <button type="submit" class="btn-secondary" style="flex:1;" name="save_mode" value="variant"
                  formaction="{{ url_for('save_from_use', prompt_id=prompt.id) }}"
                  title="Save this as a new child variant linked to this prompt">üìé Save as Variant</button>
      </div>
  </form>

</section>

<script>
function updateFinal() {
    let text = document.getElementById('templateSource').value;
    const inputs = document.querySelectorAll('.placeholder-input');
    inputs.forEach(input => {
        const key = input.getAttribute('data-target');
        const val = input.value;
        if(val) {
            const regex = new RegExp(`\\[\\[${key}\\]\\]`, 'g');
            text = text.replace(regex, val);
        }
    });
    document.getElementById('finalOutput').value = text;
}

function copyToClipboard() {
    const text = document.getElementById('finalOutput').value;
    navigator.clipboard.writeText(text).then(() => {
        const feedback = document.getElementById('copyFeedback');
        feedback.style.opacity = '1';
        setTimeout(() => feedback.style.opacity = '0', 2000);
    });
}
</script>
{% endblock %}