{% extends "base.html" %}

{% block content %}
<section class="page" style="max-width: 800px; margin: 0 auto;">
  <div class="page-header">
    <h2>Refine Prompt (Ollama)</h2>
    <a class="btn-secondary" href="{{ url_for('render_prompt', prompt_id=prompt.id) }}">Back to Use</a>
  </div>

  <div class="prompt-meta" style="margin-bottom:1.5rem;">
      <h3 style="margin:0;">{{ prompt.title }}</h3>
      <p style="opacity:0.7; margin-top:0.25rem;">{{ prompt.category }} · {{ prompt.tool }} · {{ prompt.prompt_type }}</p>
  </div>

  {% if not ollama_available %}
    <div style="background: #300; color: #fcc; padding: 1rem; border-radius: 8px; border: 1px solid #c00;">
        <strong>Error:</strong> Ollama is not detected. Please ensure Ollama is running.
    </div>
  {% else %}
    <form method="post" class="form">
      
      <div class="grid-2">
          <div>
              <label>Model</label>
              <select name="model">
                  {% for m in models %}
                    <option value="{{ m }}" {% if session.get('ollama_model') == m %}selected{% endif %}>{{ m }}</option>
                  {% endfor %}
              </select>
          </div>
          <div>
              <label>Instruction (Optional)</label>
              <textarea name="instruction" rows="2" placeholder="e.g. Make it more descriptive, remove negative words..."></textarea>
          </div>
      </div>

      <div style="margin-top:1rem;">
          <label>Source text (Edit before sending if desired)</label>
          <textarea name="content" rows="12" style="font-family:monospace; line-height:1.4;">{{ prompt.content }}</textarea>
      </div>

      <div style="background:#1a1a1a; padding:1rem; border-radius:8px; margin-top:1.5rem; border:1px solid #333;">
          <div style="display:flex; gap:1rem; align-items:center; flex-wrap:wrap; margin-bottom:1rem;">
              <button type="submit" class="btn-primary">Refine</button>
              <span style="opacity:0.5; font-size:0.9em;">(Generates preview if no save option selected)</span>
          </div>

          <hr style="border-color:#333; margin: 1rem 0;">

          <div style="display:grid; gap:1rem;">
              <div style="display:flex; align-items:center;">
                  <input type="checkbox" name="overwrite" id="overwrite" style="margin-right:0.5rem;">
                  <label for="overwrite" style="cursor:pointer; color:#ff6b6b;">Overwrite this prompt's content</label>
              </div>

              <div style="display:flex; align-items:center; flex-wrap:wrap; gap:1rem;">
                  <div style="display:flex; align-items:center;">
                      <input type="checkbox" name="save_as_new" id="save_as_new" style="margin-right:0.5rem;" onclick="document.getElementById('newTitleBox').style.display = this.checked ? 'block' : 'none'">
                      <label for="save_as_new" style="cursor:pointer; color:#51cf66;">Save as new prompt</label>
                  </div>
                  
                  <div id="newTitleBox" style="display:none; flex:1; min-width:200px;">
                      <input type="text" name="new_title" placeholder="New Title (Optional)" value="{{ prompt.title }} (Refined)" style="width:100%; padding:0.4rem;">
                  </div>
              </div>
          </div>
      </div>

    </form>
  {% endif %}
</section>
{% endblock %}