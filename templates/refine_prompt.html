{% extends "base.html" %}

{% block content %}
<section class="page" style="max-width: 800px; margin: 0 auto;">
  <div class="page-header">
    <h2>Refine Prompt (Ollama)</h2>
    <a class="btn-secondary" href="{{ url_for('render_prompt', prompt_id=prompt.id) }}">Back to Use</a>
  </div>

  <div class="prompt-meta" style="margin-bottom:1.5rem;">
      <h3 style="margin:0;">{{ prompt.title }}</h3>
      <p style="opacity:0.7; margin-top:0.25rem;">{{ prompt.category }} · {{ prompt.tool }} · {{ prompt.prompt_type }}</p>
  </div>

  {% if not ollama_available %}
    <div style="background: #300; color: #fcc; padding: 1rem; border-radius: 8px; border: 1px solid #c00;">
        <strong>Error:</strong> Ollama is not detected. Please ensure Ollama is running.
    </div>
  {% else %}
    <form method="post" class="form">
      
      <div class="grid-2">
          <div>
              <label>Model</label>
              <select name="model">
                  {% for m in models %}
                    <option value="{{ m }}" {% if session.get('ollama_model') == m %}selected{% endif %}>{{ m }}</option>
                  {% endfor %}
              </select>
          </div>
          <div>
              <label>Instruction (Optional)</label>
              <textarea name="instruction" rows="2" placeholder="e.g. Make it more descriptive..."></textarea>
          </div>
      </div>

      <div style="margin-top:1rem;">
          <label>Source text (Edit before sending if desired)</label>
          <textarea name="content" rows="12" style="font-family:monospace; line-height:1.4;">{{ prompt.content }}</textarea>
      </div>

      <div style="background:#1a1a1a; padding:1.5rem; border-radius:8px; margin-top:2rem; border:1px solid #333;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
              <h3 style="margin:0; font-size:1.1em;">Save Options</h3>
              <button type="submit" class="btn-primary" style="padding:0.6rem 1.5rem;">Generate / Save</button>
          </div>

          <div style="display:grid; gap:1rem;">
              
              <label style="display:flex; align-items:center; padding:0.5rem; background:#222; border-radius:4px; cursor:pointer;">
                  <input type="radio" name="save_action" value="" checked style="margin-right:1rem;">
                  <span><strong>Preview Only</strong> <span style="opacity:0.6; font-size:0.9em;">— Just show me the result, don't save yet.</span></span>
              </label>

              <label style="display:flex; align-items:center; padding:0.5rem; background:#222; border-radius:4px; cursor:pointer;">
                  <input type="radio" name="save_action" value="overwrite" style="margin-right:1rem;">
                  <span style="color:#ff6b6b;"><strong>Overwrite</strong> <span style="opacity:0.6; font-size:0.9em;">— Replace the current prompt content.</span></span>
              </label>

              <label style="display:flex; align-items:center; padding:0.5rem; background:#222; border-radius:4px; cursor:pointer;">
                  <input type="radio" name="save_action" value="variant" style="margin-right:1rem;" onclick="document.getElementById('newTitleBox').style.display='block'">
                  <span style="color:#51cf66;"><strong>Save as Variant</strong> <span style="opacity:0.6; font-size:0.9em;">— Save as a child of this prompt family.</span></span>
              </label>

              <label style="display:flex; align-items:center; padding:0.5rem; background:#222; border-radius:4px; cursor:pointer;">
                  <input type="radio" name="save_action" value="new" style="margin-right:1rem;" onclick="document.getElementById('newTitleBox').style.display='block'">
                  <span><strong>Save as New Prompt</strong> <span style="opacity:0.6; font-size:0.9em;">— Create a separate, independent prompt.</span></span>
              </label>

              <div id="newTitleBox" style="display:none; margin-top:0.5rem; margin-left:2.5rem;">
                  <input type="text" name="new_title" placeholder="Title for new variant/prompt..." value="{{ prompt.title }} (Refined)" style="width:100%; padding:0.5rem;">
              </div>

          </div>
      </div>

    </form>
  {% endif %}
</section>

<script>
    // Simple logic to hide/show title box based on radio selection
    document.querySelectorAll('input[name="save_action"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            const box = document.getElementById('newTitleBox');
            if (e.target.value === 'variant' || e.target.value === 'new') {
                box.style.display = 'block';
            } else {
                box.style.display = 'none';
            }
        });
    });
</script>
{% endblock %}