{% extends "base.html" %}
{% block content %}
<section>
  <h2>Refine Prompt (Ollama)</h2>

  <div class="card" style="margin-bottom: 1rem;">
    <h3 style="margin:0;">{{ prompt.title }}</h3>
    <div class="meta">
      <span>{{ prompt.category }}</span> · <span>{{ prompt.tool }}</span> · <span>{{ prompt.prompt_type }}</span>
    </div>
  </div>

  {% if models|length == 0 %}
    <div class="flash flash-warn">
      <strong>Ollama not available.</strong> Make sure Ollama is installed and running, then refresh this page.
    </div>
    <div style="margin-top:0.75rem;">
      <a class="btn-secondary" href="{{ url_for('render_prompt', prompt_id=prompt.id) }}">Back to Use</a>
      <a class="btn-secondary" href="{{ url_for('edit_prompt', prompt_id=prompt.id) }}">Edit</a>
    </div>
  {% else %}
    <form method="post">
      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 0.75rem;">
        <label>Model
          <select name="model">
            {% for m in models %}
              <option value="{{ m }}" {% if m == selected_model %}selected{% endif %}>{{ m }}</option>
            {% endfor %}
          </select>
        </label>

        <label>Instruction
          <textarea name="instruction" rows="4" placeholder="{{ instruction_default }}">{{ request.form.get('instruction','') }}</textarea>
        </label>
      </div>

      <label style="margin-top:0.75rem;">Source text (edit before sending to Ollama if you want)
        <textarea name="source_text" rows="10">{{ request.form.get('source_text', prompt.content or '') }}</textarea>
      </label>

      <div style="margin-top:0.75rem; display:flex; gap:0.75rem; flex-wrap:wrap; align-items:center;">
        <button type="submit">Refine</button>
        <a class="btn-secondary" href="{{ url_for('render_prompt', prompt_id=prompt.id) }}">Back to Use</a>
      </div>

      <div style="margin-top:0.75rem; display:flex; gap:1.25rem; flex-wrap:wrap; align-items:center;">
        <label style="display:flex; gap:0.5rem; align-items:center;">
          <input type="checkbox" name="overwrite">
          Overwrite this prompt’s content
        </label>

        <label style="display:flex; gap:0.5rem; align-items:center;">
          <input type="checkbox" name="save_as_new">
          Save as new prompt
        </label>

        <label>New title (when saving as new)
          <input type="text" name="new_title" placeholder="{{ prompt.title }} (Refined)">
        </label>
      </div>

      {% if refined_text %}
        <hr style="margin: 1.25rem 0; border: 0; border-top: 1px solid #333;" />
        <h3>Refined result</h3>
        <textarea id="refinedText" rows="12" style="width:100%;" readonly>{{ refined_text }}</textarea>
        <div style="margin-top:0.75rem; display:flex; gap:0.75rem; flex-wrap:wrap;">
          <button type="button" onclick="navigator.clipboard.writeText(document.getElementById('refinedText').value)">Copy refined text</button>
        </div>
      {% endif %}
    </form>
  {% endif %}
</section>
{% endblock %}
