{% extends "base.html" %}

{% block content %}
<section class="page" style="max-width: 980px; margin: 0 auto;">

  <div class="page-header" style="display:flex; justify-content:space-between; align-items:flex-end; gap:1rem; flex-wrap:wrap;">
    <div>
      <h2 style="margin:0;">
        {% if prompt and prompt.id %}Edit Prompt{% else %}New Prompt{% endif %}
      </h2>
      {% if prompt and prompt.parent_id %}
         <div style="font-size:0.9rem; margin-top:0.25rem;">
            ‚Ü≥ Variant of <a href="{{ url_for('edit_prompt', prompt_id=prompt.parent_id) }}" style="color:#00bfff;">Prompt #{{ prompt.parent_id }}</a>
         </div>
      {% endif %}
    </div>

    <div style="display:flex; gap:.5rem; align-items:center; flex-wrap:wrap;">
      {% if prompt and prompt.id %}
        <a class="btn-secondary" href="{{ url_for('render_prompt', prompt_id=prompt.id) }}">Use</a>
        <a class="btn-secondary" href="{{ url_for('prompt_history', prompt_id=prompt.id) }}">History</a>
      {% endif %}
      <a class="btn-secondary" href="{{ url_for('index') }}">Back</a>
    </div>
  </div>

  <form method="POST" action="{% if prompt and prompt.id %}{{ url_for('edit_prompt', prompt_id=prompt.id) }}{% else %}{{ url_for('new_prompt') }}{% endif %}"
        enctype="multipart/form-data"
        style="margin-top: 1rem;">

    <div style="display:grid; grid-template-columns: 1fr; gap:0.75rem;">
      <label>
        Title
        <input type="text" name="title" value="{{ prompt.title if prompt else '' }}" required>
      </label>

      <label>
        Category
        <input type="text" name="category" value="{{ prompt.category if prompt else '' }}" placeholder="Optional">
      </label>

      <!-- Notes -->
      <label>
        Notes
        <textarea name="notes" rows="4" placeholder="Optional notes (shown on Use page)">{{ prompt.notes if prompt and prompt.notes else '' }}</textarea>
      </label>

      <label>
        Prompt Content
        <textarea name="content" id="contentEditor" rows="18" style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;">{{ prompt.content if prompt else '' }}</textarea>
      </label>

      <details id="thumbPanel" style="background:#1a1a1a; padding:1rem; border-radius:8px; border:1px solid #333;">
        <summary style="cursor:pointer; user-select:none; display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap;">
          <span style="font-weight:bold;">üñºÔ∏è Thumbnail</span>
          <span style="opacity:0.7; font-size:0.9em;">Upload or generate</span>
        </summary>

        <div style="margin-top:1rem; display:flex; flex-direction:column; gap:0.75rem;">
          <div style="display:flex; gap:0.75rem; flex-wrap:wrap; align-items:flex-start;">
            <div style="flex:0 0 220px;">
              <div style="border:1px solid #333; border-radius:10px; background:#111; padding:0.5rem;">
                {% if prompt and prompt.thumbnail_path %}
                  <img id="mainThumbPreview" src="{{ url_for('static', filename=prompt.thumbnail_path) }}" alt="Thumbnail" style="width:100%; border-radius:8px;">
                {% else %}
                  <img id="mainThumbPreview" src="" alt="Thumbnail" style="width:100%; border-radius:8px; display:none;">
                  <div id="mainThumbEmpty" style="opacity:0.7; padding:1rem; text-align:center;">No thumbnail</div>
                {% endif %}
              </div>
            </div>

            <div style="flex:1; min-width: 260px; display:flex; flex-direction:column; gap:0.75rem;">
              <label>
                Upload new thumbnail (PNG/JPG/WebP)
                <input type="file" name="thumbnail_file" accept="image/png,image/jpeg,image/webp">
              </label>

              <div style="display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center;">
                <button type="button" class="btn-secondary" id="btnGenerateThumb">Generate AI thumbnail</button>
                <span id="thumbStatus" style="font-size:0.9em; opacity:0.7;"></span>
              </div>

              <div style="display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center;">
                <label style="font-size:0.85em; opacity:0.75;">Model</label>
                <select id="thumbModel" style="min-width: 220px;">
                  <option value="gpt-image-1">gpt-image-1</option>
                  <option value="dall-e-3">dall-e-3</option>
                </select>
                <label style="font-size:0.85em; opacity:0.75;">Size</label>
                <select id="thumbSize" style="min-width: 120px;">
                  <option value="1024x1024">1024x1024</option>
                  <option value="1024x768">1024x768</option>
                  <option value="768x1024">768x1024</option>
                </select>
              </div>

              <label>
                Thumbnail prompt (optional override)
                <input type="text" id="thumbPrompt" placeholder="If blank, PromptHub will summarise the prompt content.">
              </label>

              <div style="opacity:0.7; font-size:0.9em;">
                Generated thumbnails appear immediately and are saved with the prompt.
              </div>
            </div>
          </div>
        </div>
      </details>

      <details id="descriptorPanel" style="background:#1a1a1a; padding:1rem; border-radius:8px; border:1px solid #333;">
        <summary style="cursor:pointer; user-select:none; display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap;">
          <span style="font-weight:bold;">üß© Descriptors</span>
          <span style="opacity:0.7; font-size:0.9em;">Insert tokens or manage types</span>
        </summary>

        <div style="margin-top:1rem; display:flex; flex-direction:column; gap:0.75rem;">
          <div style="display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center;">
            <label style="font-size:0.85em; opacity:0.7; text-transform:uppercase; letter-spacing:0.08em;">Type</label>
            <select id="descType" style="min-width: 220px;">
              <option value="">(Select type)</option>
            </select>

            <label style="font-size:0.85em; opacity:0.7; text-transform:uppercase; letter-spacing:0.08em;">Search</label>
            <input type="text" id="descSearch" placeholder="Search descriptors..." style="flex:1; min-width: 220px;">

            <button type="button" class="btn-secondary" id="btnDescSearch">Search</button>
            <span id="descStatus" style="font-size:0.9em; opacity:0.7;"></span>
          </div>

          <div id="descResults" style="border:1px solid #333; border-radius:8px; max-height:320px; overflow:auto; background:#111; padding:0.5rem;">
            <div style="opacity:0.7; padding:0.75rem;">Select a type and search.</div>
          </div>

          <div style="opacity:0.7; font-size:0.9em;">
            Clicking ‚ÄúInsert token‚Äù adds a token at the cursor in the Prompt Content box.
          </div>
        </div>
      </details>

    </div>

    {% if prompt and prompt.id %}
      {% set root_id = prompt.parent_id if prompt.parent_id else prompt.id %}
      <details id="variantsPanel" style="background:#1a1a1a; padding:1rem; border-radius:8px; margin-top:1rem; border:1px solid #333;">
        <summary style="cursor:pointer; user-select:none; display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap;">
          <span style="font-weight:bold;">üìé Variants</span>
          <span style="opacity:0.7; font-size:0.9em;">View and switch within this family</span>
        </summary>

        <div style="margin-top:0.9rem; display:flex; flex-direction:column; gap:0.75rem;">
          <input type="hidden" id="variantsRootId" value="{{ root_id }}">

          <div style="display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center;">
            <button type="button" class="btn-secondary" id="btnLoadVariants">Load family</button>
            <span id="variantsStatus" style="font-size:0.9em; opacity:0.7;"></span>
          </div>

          <div id="variantsContainer" style="border:1px solid #333; border-radius:8px; background:#111; padding:0.75rem; max-height:520px; overflow:auto;">
            <div style="opacity:0.75;">Click ‚ÄúLoad family‚Äù to show the main prompt and its variants here.</div>
          </div>
        </div>
      </details>
    {% endif %}

    <div style="display:flex; gap:.75rem; align-items:center; flex-wrap:wrap; margin-top:1.5rem;">
      <button type="submit">Save</button>

      {% if prompt and prompt.id %}
        <button type="submit" class="btn-secondary" name="save_as_variant" value="1">Save as Variant</button>
      {% endif %}
    </div>

  </form>

</section>

<script>
(function () {
  // Utilities
  const contentEditor = document.getElementById('contentEditor');
  function insertAtCursor(text) {
    if (!contentEditor) return;
    const start = contentEditor.selectionStart || 0;
    const end = contentEditor.selectionEnd || 0;
    const v = contentEditor.value || '';
    contentEditor.value = v.slice(0, start) + text + v.slice(end);
    const pos = start + text.length;
    contentEditor.focus();
    contentEditor.setSelectionRange(pos, pos);
  }

  // Descriptors
  const descType = document.getElementById('descType');
  const descSearch = document.getElementById('descSearch');
  const btnDescSearch = document.getElementById('btnDescSearch');
  const descResults = document.getElementById('descResults');
  const descStatus = document.getElementById('descStatus');

  let descTypesLoaded = false;

  // ==========================================
  // 0.1 VARIANTS (Prompt family) - template only
  // ==========================================
  const variantsRoot = document.getElementById('variantsRootId');
  const variantsBtn = document.getElementById('btnLoadVariants');
  const variantsContainer = document.getElementById('variantsContainer');
  const variantsStatus = document.getElementById('variantsStatus');

  async function loadPromptFamily() {
    if (!variantsRoot || !variantsContainer) return;
    const rootId = String(variantsRoot.value || '').trim();
    if (!rootId) return;

    if (variantsStatus) variantsStatus.textContent = 'Loading‚Ä¶';
    variantsContainer.innerHTML = '<div style="opacity:0.75; padding:0.75rem;">Loading‚Ä¶</div>';

    try {
      const params = new URLSearchParams();
      params.set('view_family', rootId);
      params.set('per_page', '60');
      params.set('page', '1');
      params.set('sort_by', 'created_at');
      params.set('sort_dir', 'asc');

      const res = await fetch('/api/prompts?' + params.toString(), { headers: { 'Accept': 'application/json' } });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();

      if (data && typeof data.html === 'string' && data.html.trim()) {
        variantsContainer.innerHTML = data.html;
        if (variantsStatus) variantsStatus.textContent = 'Loaded.';
      } else {
        variantsContainer.innerHTML = '<div style="opacity:0.75; padding:0.75rem;">No family items found.</div>';
        if (variantsStatus) variantsStatus.textContent = '';
      }
    } catch (e) {
      console.error('Failed to load family', e);
      variantsContainer.innerHTML = '<div style="opacity:0.75; padding:0.75rem;">Failed to load family.</div>';
      if (variantsStatus) variantsStatus.textContent = '';
    }
  }

  if (variantsBtn) {
    variantsBtn.addEventListener('click', loadPromptFamily);
  }

  async function loadDescriptorTypes() {
    if (descTypesLoaded) return;
    if (!descType) return;
    try {
      const res = await fetch('/api/descriptors/types', { headers: { 'Accept': 'application/json' } });
      if (!res.ok) throw new Error('types');
      const types = await res.json();
      if (!Array.isArray(types)) return;

      types.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t;
        opt.textContent = t;
        descType.appendChild(opt);
      });

      descTypesLoaded = true;
    } catch (e) {
      console.error('Failed to load descriptor types', e);
    }
  }

  function setDescStatus(msg) {
    if (descStatus) descStatus.textContent = msg || '';
  }

  function renderDescriptorResults(items) {
    if (!descResults) return;
    if (!items.length) {
      descResults.innerHTML = '<div style="opacity:0.7; padding:0.75rem;">No results.</div>';
      return;
    }

    descResults.innerHTML = '';
    items.forEach(d => {
      const row = document.createElement('div');
      row.style.display = 'flex';
      row.style.gap = '0.5rem';
      row.style.alignItems = 'center';
      row.style.justifyContent = 'space-between';
      row.style.borderBottom = '1px solid #222';
      row.style.padding = '0.55rem 0.6rem';

      const left = document.createElement('div');
      left.style.flex = '1';
      left.style.minWidth = '0';

      const title = document.createElement('div');
      title.textContent = d.name || d.id || 'descriptor';
      title.style.fontWeight = 'bold';
      title.style.whiteSpace = 'nowrap';
      title.style.overflow = 'hidden';
      title.style.textOverflow = 'ellipsis';

      const meta = document.createElement('div');
      meta.textContent = (d.type ? (d.type + ' ‚Ä¢ ') : '') + (d.pack || '');
      meta.style.opacity = '0.7';
      meta.style.fontSize = '0.85em';
      meta.style.whiteSpace = 'nowrap';
      meta.style.overflow = 'hidden';
      meta.style.textOverflow = 'ellipsis';

      left.appendChild(title);
      left.appendChild(meta);

      const actions = document.createElement('div');
      actions.style.display = 'flex';
      actions.style.gap = '0.5rem';
      actions.style.flexWrap = 'wrap';
      actions.style.alignItems = 'center';

      const btnToken = document.createElement('button');
      btnToken.type = 'button';
      btnToken.className = 'btn-secondary';
      btnToken.textContent = 'Insert token';
      btnToken.onclick = () => {
        // Insert token form Descriptor ID without typing literal braces in template text.
        const open = String.fromCharCode(123, 123);
        const close = String.fromCharCode(125, 125);
        insertAtCursor(open + 'descriptor:' + d.id + close);
      };

      const btnText = document.createElement('button');
      btnText.type = 'button';
      btnText.className = 'btn-secondary';
      btnText.textContent = 'Insert text';
      btnText.onclick = () => {
        insertAtCursor(d.rendered_text || d.text || d.name || '');
      };

      actions.appendChild(btnToken);
      actions.appendChild(btnText);

      row.appendChild(left);
      row.appendChild(actions);

      descResults.appendChild(row);
    });
  }

  async function searchDescriptors() {
    if (!descType || !descResults) return;

    const type = String(descType.value || '').trim();
    const q = String(descSearch?.value || '').trim();

    if (!type) {
      setDescStatus('Select a type.');
      return;
    }

    setDescStatus('Loading‚Ä¶');
    descResults.innerHTML = '<div style="opacity:0.7; padding:0.75rem;">Loading‚Ä¶</div>';

    try {
      const params = new URLSearchParams();
      params.set('type', type);
      if (q) params.set('q', q);

      const res = await fetch('/api/descriptors/list?' + params.toString(), { headers: { 'Accept': 'application/json' } });
      if (!res.ok) throw new Error('list');
      const data = await res.json();
      const items = Array.isArray(data) ? data : [];

      setDescStatus(items.length ? (items.length + ' found') : 'No results');
      renderDescriptorResults(items);
    } catch (e) {
      console.error('Failed to search descriptors', e);
      setDescStatus('Failed to load');
      descResults.innerHTML = '<div style="opacity:0.8; padding:0.75rem;">Could not load descriptors.</div>';
    }
  }

  if (btnDescSearch) {
    btnDescSearch.addEventListener('click', searchDescriptors);
  }

  // Thumbnail generation (existing behaviour)
  const btnGenerateThumb = document.getElementById('btnGenerateThumb');
  const thumbStatus = document.getElementById('thumbStatus');
  const thumbModel = document.getElementById('thumbModel');
  const thumbSize = document.getElementById('thumbSize');
  const thumbPrompt = document.getElementById('thumbPrompt');
  const mainThumbPreview = document.getElementById('mainThumbPreview');
  const mainThumbEmpty = document.getElementById('mainThumbEmpty');

  async function generateThumbnail() {
    if (!btnGenerateThumb) return;
    btnGenerateThumb.disabled = true;
    if (thumbStatus) thumbStatus.textContent = 'Generating‚Ä¶';

    try {
      const payload = {
        prompt_id: {{ prompt.id if prompt and prompt.id else 'null' }},
        model: thumbModel ? thumbModel.value : 'gpt-image-1',
        size: thumbSize ? thumbSize.value : '1024x1024',
        prompt_override: thumbPrompt ? thumbPrompt.value : ''
      };

      const res = await fetch('/api/prompts/generate_thumbnail', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!res.ok) throw new Error('thumb ' + res.status);
      const data = await res.json();

      if (data && data.thumbnail_path) {
        if (mainThumbEmpty) mainThumbEmpty.style.display = 'none';
        if (mainThumbPreview) {
          mainThumbPreview.style.display = 'block';
          mainThumbPreview.src = "{{ url_for('static', filename='') }}" + data.thumbnail_path;
        }
        if (thumbStatus) thumbStatus.textContent = 'Saved.';
      } else {
        if (thumbStatus) thumbStatus.textContent = 'No image returned.';
      }
    } catch (e) {
      console.error('Thumbnail generation failed', e);
      if (thumbStatus) thumbStatus.textContent = 'Failed.';
    } finally {
      btnGenerateThumb.disabled = false;
    }
  }

  if (btnGenerateThumb) {
    btnGenerateThumb.addEventListener('click', generateThumbnail);
  }

  // Init
  loadDescriptorTypes();

})();
</script>

{% endblock %}
