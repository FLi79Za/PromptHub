<!-- templates/edit_prompt.html -->
{% extends "base.html" %}

{% block content %}
<section class="page">
  <div class="page-header" style="display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap;">
    <div>
      <h2 style="margin:0;">
        {% if prompt and prompt.id %}Edit Prompt{% else %}New Prompt{% endif %}
      </h2>
      {% if prompt %}
        {% if parent %}
           <div style="font-size:0.9rem; margin-top:0.25rem;">
              ↳ Variant of <a href="{{ url_for('edit_prompt', prompt_id=parent.id) }}" style="color:#00bfff;">{{ parent.title }}</a>
           </div>
        {% endif %}
      {% endif %}
    </div>

    <div style="display:flex; gap:.5rem; align-items:center; flex-wrap:wrap;">
      {% if prompt and prompt.id %}
        <a class="btn-secondary" href="{{ url_for('render_prompt', prompt_id=prompt.id) }}">Use</a>

        <form method="post" action="{{ url_for('duplicate_prompt', prompt_id=prompt.id) }}" style="display:inline;">
          <button class="btn-secondary" type="submit">Copy</button>
        </form>

        <button class="btn-secondary" type="submit"
                form="mainPromptForm"
                formaction="{{ url_for('duplicate_prompt', prompt_id=prompt.id) }}"
                name="as_variant" value="true"
                title="Create a child version linked to this prompt using your current edits">Make Variant</button>
      {% endif %}
      <a class="btn-secondary" href="{{ url_for('index') }}">Back</a>
    </div>
  </div>

  {% if not prompt or not prompt.id %}
    {% if ollama_models %}
    <details style="background:#1a1a1a; padding:1rem; border-radius:8px; margin-bottom:1.5rem; border:1px solid #333;">
        <summary style="cursor:pointer; font-weight:bold; color:#00bfff;">✨ Generate Draft Prompt from Image (Vision)</summary>

        <div style="margin-top:1rem; display:grid; grid-template-columns: 1fr 1fr; gap:1.5rem;">

            <div>
                <label style="margin-bottom:0.5rem; display:block;">Reference Image</label>
                <div id="visionDropZone" class="drop-zone" style="border:2px dashed #444; padding:2rem; text-align:center; border-radius:8px; cursor:pointer; background:#111;">
                    <div id="visionDropText" style="color:#888;">
                        Drag image here or click to upload
                    </div>
                    <input type="file" id="visionFile" accept="image/*" style="display:none;">
                    <img id="visionPreview" style="max-width:100%; max-height:200px; margin-top:1rem; display:none; border-radius:4px;">
                </div>
            </div>

            <div style="display:flex; flex-direction:column; gap:1rem;">
               <div style="display:grid; grid-template-columns: 1fr 1fr; gap:1rem;">
                   <div>
                       <label>Vision Model</label>
                       <select id="visionModel" style="width:100%;">
                           {% for m in ollama_models %}
                               <option value="{{ m }}" {% if 'llava' in m or 'vision' in m or 'qwen' in m %}selected{% endif %}>{{ m }}</option>
                           {% endfor %}
                       </select>
                   </div>
                   <div>
                       <label>Text Model</label>
                       <select id="textModel" style="width:100%;">
                           {% for m in ollama_models %}
                               <option value="{{ m }}">{{ m }}</option>
                           {% endfor %}
                       </select>
                   </div>
               </div>

               <div>
                   <label>Vision Instructions (Optional)</label>
                   <textarea id="customVisionInstruction" rows="2" placeholder="Tell the vision model what to look for (e.g. 'Describe lighting details')" style="width:100%; font-size:0.9em;"></textarea>
               </div>

               <div>
                   <label>Drafting Instructions (Optional)</label>
                   <textarea id="customDraftInstruction" rows="2" placeholder="Tell the text model how to write (e.g. 'Use colourful, poetic language')" style="width:100%; font-size:0.9em;"></textarea>
               </div>

               <div id="visionStatus" style="font-size:0.9em; color:#888; min-height:1.2em;"></div>

               <button type="button" id="btnGenerateDraft" class="btn-primary" style="margin-top:auto;">Generate Draft & Set Thumbnail</button>
            </div>
        </div>
    </details>
    {% endif %}
  {% endif %}

  <form method="post"
        id="mainPromptForm"
        {% if prompt and prompt.id %} action="{{ url_for('edit_prompt', prompt_id=prompt.id) }}"
        {% else %} action="{{ url_for('new_prompt') }}" {% endif %}
        enctype="multipart/form-data" class="form">

    <input type="hidden" name="hidden_thumbnail_path" id="hiddenThumb">
    <input type="hidden" id="jsPromptId" value="{{ prompt.id if prompt and prompt.id else '' }}">

    <div class="grid-2">
      <div>
        <label>Title</label>
        <input type="text" name="title" value="{{ prompt.title if prompt else '' }}" required>
      </div>
      <div>
        <label>Prompt Type</label>
        <select name="prompt_type" required>
          {% for pt in prompt_types %}
            <option value="{{ pt }}" {% if prompt and prompt.prompt_type == pt %}selected{% endif %}>{{ pt }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <div class="grid-2">
      <div>
        <label>Category</label>
        <input list="category_list" name="category" value="{{ prompt.category if prompt else '' }}" placeholder="Select or type new..." autocomplete="off" required>
        <datalist id="category_list">
          {% for c in categories %}
            <option value="{{ c }}">
          {% endfor %}
        </datalist>
      </div>
      <div>
        <label>Tool</label>
        <input list="tool_list" name="tool" value="{{ prompt.tool if prompt else '' }}" placeholder="Select or type new..." autocomplete="off" required>
        <datalist id="tool_list">
          {% for t in tools %}
            <option value="{{ t }}">
          {% endfor %}
        </datalist>
      </div>
    </div>

    <div>
      <label>Tags (comma separated)</label>
      <input type="text" name="tags" value="{{ tags_str }}" placeholder="e.g. Portrait, Realistic, Sci-Fi, Dark">
    </div>

    <div class="grid-2">
      <div>
        <label>Group (optional)</label>
        <select name="group_id" style="width:100%;">
          <option value="">No group</option>
          {% for g in groups %}
            <option value="{{ g.id }}" {% if prompt and prompt.group_id|string == g.id|string %}selected{% endif %}>{{ g.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label>Or create new group</label>
        <input type="text" name="new_group_name" placeholder="Eg. My Project">
      </div>
    </div>

    <div>
      <div style="display:flex; justify-content:space-between; align-items:end; margin-bottom:0.5rem; gap:0.75rem; flex-wrap:wrap;">
          <label style="margin-bottom:0;">Prompt Content</label>

          <div style="display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap;">
            <button type="button" id="openDescriptorPicker" class="btn-secondary" style="padding:0.2rem 0.6rem; font-size:0.85rem;">Insert Descriptor</button>

            {% if ollama_models %}
            <div style="font-size:0.85rem; display:flex; gap:0.5rem; align-items:center;">
                <select id="quickRefineModel" style="padding:0.2rem; max-width:150px;">
                    {% for m in ollama_models %}
                      <option value="{{ m }}" {% if session.get('ollama_model') == m %}selected{% endif %}>{{ m }}</option>
                    {% endfor %}
                </select>
                <button type="button" id="btnToggleRefine" class="btn-secondary" style="padding:0.2rem 0.6rem; font-size:0.85rem;">✨ Enhance...</button>
            </div>
            {% endif %}
          </div>
      </div>

      <div id="refineTools" style="display:none; background:#222; padding:0.75rem; border-radius:4px; margin-bottom:0.5rem; border:1px solid #444;">
          <div style="display:flex; flex-direction:column; gap:0.5rem;">

              <div>
                  <label style="font-size:0.75em; color:#888; display:block; margin-bottom:0.2rem;">System Role (Persona)</label>
                  <input type="text" id="quickRefineSystem" value="You are an expert prompt engineer. Output ONLY the refined prompt text." style="font-size:0.85rem; width:100%; color:#aaa; background:#111; border:1px solid #333;">
              </div>

              <div>
                   <label style="font-size:0.75em; color:#888; display:block; margin-bottom:0.2rem;">Instruction</label>
                   <div style="display:grid; grid-template-columns: 1fr auto; gap:0.5rem;">
                      <input type="text" id="quickRefineInstruction" placeholder="e.g. 'Add cinematic lighting' or 'Make it spooky'" style="font-size:0.9rem;">
                      <button type="button" id="btnRunRefine" class="btn-primary" style="padding:0.4rem 1rem; font-size:0.9rem;">Run</button>
                   </div>
              </div>
          </div>

          <div style="margin-top:0.5rem; font-size:0.8em; color:#888; display:flex; justify-content:space-between;">
             <span>Updates text below.</span>
             <span id="refineStatus" style="color:#00bfff;"></span>
          </div>
      </div>

      <textarea name="content" id="content" rows="10" required style="width:100%;">{{ prompt.content if prompt else '' }}</textarea>
      <div style="margin-top:0.35rem; font-size:0.8em; color:#777;">
        Tip: “Insert Descriptor” is optional. You can paste text or insert a token like <code>{{ '{{' }}descriptor:123{{ '}}' }}</code>.
      </div>
    </div>

    <div>
      <label>Notes</label>
      <textarea name="notes" id="notes" rows="4">{{ prompt.notes if prompt and prompt.notes else '' }}</textarea>
    </div>

    <div>
        <label id="mainThumbLabel">Thumbnail (drag & drop allowed)</label>
        <input type="file" name="thumbnail" accept="image/*" id="mainThumbInput">

        <div id="mainThumbDropZone" style="margin-top:0.75rem; padding: 0.5rem; border: 2px dashed #444; border-radius: 4px; display: inline-block; min-width: 150px; text-align: center; transition: border-color 0.2s;">
             <img id="mainThumbPreview"
                  src="{{ url_for('serve_thumbnail', prompt_id=prompt.id) if prompt and prompt.thumbnail else '' }}"
                  style="max-height: 120px; border-radius: 4px; display: {% if prompt and prompt.thumbnail %}block{% else %}none{% endif %};">
             <div id="mainThumbPlaceholder" style="color:#777; padding:0.5rem; display: {% if prompt and prompt.thumbnail %}none{% else %}block{% endif %};">
                 Drop image here
             </div>
        </div>
    </div>

    <div style="display:flex; gap:0.75rem; flex-wrap:wrap; margin-top:1.25rem;">
      <button type="submit" class="btn-primary">{% if prompt and prompt.id %}Save Changes{% else %}Create Prompt{% endif %}</button>
      {% if prompt and prompt.id %}
        <a class="btn-secondary" href="{{ url_for('render_prompt', prompt_id=prompt.id) }}">Use</a>
      {% endif %}
    </div>

  </form>

  <!-- Descriptor Picker Modal (Edit/New Prompt) -->
  <div id="descriptorModalBackdrop" style="position:fixed; inset:0; background:rgba(0,0,0,0.55); display:none; z-index:9998;"></div>

  <div id="descriptorModal" style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:min(980px, calc(100vw - 2rem)); max-height:calc(100vh - 2rem); background:#111; border:1px solid #333; border-radius:10px; display:none; z-index:9999; overflow:hidden;">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:0.75rem; padding:0.75rem 0.9rem; border-bottom:1px solid #222; background:#0e0e0e;">
      <div style="display:flex; flex-direction:column; gap:0.15rem;">
        <div style="font-weight:bold;">Insert Descriptor</div>
        <div style="opacity:0.7; font-size:0.9em;">Insert descriptor text or a token into the prompt content.</div>
      </div>
      <button type="button" class="btn-secondary" id="descriptorModalClose" title="Close">Close</button>
    </div>

    <div style="padding:0.9rem; display:flex; flex-direction:column; gap:0.75rem;">
      <div style="display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center; justify-content:space-between;">
        <div style="display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap;">
          <label style="margin:0; font-size:0.85em; opacity:0.7; text-transform:uppercase; letter-spacing:0.08em;">Pack</label>
          <select id="descriptorModalPack" style="min-width: 220px;">
            <option value="all">(All packs)</option>
          </select>
        </div>

        <div style="display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap;">
          <input type="text" id="descriptorModalSearch" placeholder="Search descriptors..." style="min-width:280px; flex:1;">
          <button type="button" class="btn-secondary" id="descriptorModalSearchBtn">Search</button>
          <span id="descriptorModalStatus" style="font-size:0.9em; opacity:0.7;"></span>
        </div>
      </div>

      <div id="descriptorModalResults" style="border:1px solid #333; border-radius:8px; background:#0e0e0e; max-height:56vh; overflow:auto; padding:0.5rem;">
        <div style="opacity:0.7; padding:0.75rem;">Loading descriptors…</div>
      </div>

      <div style="font-size:0.9em; opacity:0.75;">
        Tip: use “Insert token” if you want to keep the prompt content compact and resolve it later.
      </div>
    </div>
  </div>

</section>

<script>
(function () {
  const btnGenerateDraft = document.getElementById("btnGenerateDraft");

  // =========================
  // Descriptor Picker (Edit/New Prompt)
  // =========================
  const openBtn = document.getElementById("openDescriptorPicker");
  const modal = document.getElementById("descriptorModal");
  const backdrop = document.getElementById("descriptorModalBackdrop");
  const closeBtn = document.getElementById("descriptorModalClose");

  const packSel = document.getElementById("descriptorModalPack");
  const searchEl = document.getElementById("descriptorModalSearch");
  const searchBtn = document.getElementById("descriptorModalSearchBtn");
  const statusEl = document.getElementById("descriptorModalStatus");
  const resultsEl = document.getElementById("descriptorModalResults");
  const contentTa = document.getElementById("content");

  let _modalTypesLoaded = false;
  let _modalTimer = null;

  function setModalStatus(msg) {
    if (statusEl) statusEl.textContent = msg || "";
  }

  function showModal() {
    if (modal) modal.style.display = "block";
    if (backdrop) backdrop.style.display = "block";
    setModalStatus("");
    if (!_modalTypesLoaded) {
      loadModalTypesAndPopulate().then(() => {
        refreshModalDescriptors();
      }).catch(() => {
        refreshModalDescriptors();
      });
    } else {
      refreshModalDescriptors();
    }
    if (searchEl) searchEl.focus();
  }

  function hideModal() {
    if (modal) modal.style.display = "none";
    if (backdrop) backdrop.style.display = "none";
    setModalStatus("");
  }

  function insertTextAtCursor(text) {
    if (!contentTa) return;
    const t = String(text || "");
    const s = contentTa.selectionStart || 0;
    const e = contentTa.selectionEnd || 0;
    const before = contentTa.value.slice(0, s);
    const after = contentTa.value.slice(e);
    contentTa.value = before + t + after;
    const newPos = s + t.length;
    contentTa.focus();
    contentTa.setSelectionRange(newPos, newPos);
  }

  function buildTokenForId(id) {
    const open = String.fromCharCode(123, 123);
    const close = String.fromCharCode(125, 125);
    return open + "descriptor:" + String(id || "") + close;
  }

  async function fetchJson(url) {
    const res = await fetch(url, { method: "GET", headers: { "Accept": "application/json" } });
    if (!res.ok) throw new Error("fetch");
    return await res.json();
  }

  async function loadModalTypesAndPopulate() {
    if (!packSel) return;
    const data = await fetchJson("/api/descriptors/types");
    const types = Array.isArray(data) ? data : [];
    while (packSel.options.length > 1) packSel.remove(1);
    types.forEach(t => {
      const opt = document.createElement("option");
      opt.value = t;
      opt.textContent = t;
      packSel.appendChild(opt);
    });
    _modalTypesLoaded = true;
  }

  function buildModalListUrl() {
    const q = (searchEl && searchEl.value ? String(searchEl.value) : "").trim();
    const pack = (packSel && packSel.value ? String(packSel.value) : "all").trim();
    const params = new URLSearchParams();
    if (q) params.set("q", q);
    if (pack && pack !== "all") params.set("pack_type", pack);
    const base = "/api/descriptors/list";
    const qs = params.toString();
    return qs ? (base + "?" + qs) : base;
  }

  function renderModalDescriptors(items) {
    if (!resultsEl) return;

    const list = Array.isArray(items) ? items : [];
    if (!list.length) {
      resultsEl.innerHTML = "<div style=\"opacity:0.7; padding:0.75rem;\">No results.</div>";
      return;
    }

    resultsEl.innerHTML = "";

    list.forEach(d => {
      const row = document.createElement("div");
      row.style.display = "flex";
      row.style.gap = "0.75rem";
      row.style.alignItems = "flex-start";
      row.style.justifyContent = "space-between";
      row.style.borderBottom = "1px solid #222";
      row.style.padding = "0.65rem 0.6rem";

      const left = document.createElement("div");
      left.style.flex = "1";
      left.style.minWidth = "0";

      const title = document.createElement("div");
      title.textContent = d.title || d.name || d.id || "descriptor";
      title.style.fontWeight = "bold";
      title.style.whiteSpace = "nowrap";
      title.style.overflow = "hidden";
      title.style.textOverflow = "ellipsis";

      const meta = document.createElement("div");
      meta.textContent = d.pack_type || "";
      meta.style.opacity = "0.7";
      meta.style.fontSize = "0.85em";
      meta.style.whiteSpace = "nowrap";
      meta.style.overflow = "hidden";
      meta.style.textOverflow = "ellipsis";

      const body = document.createElement("div");
      const bodyText = String(d.rendered_text || d.text || "");
      body.textContent = bodyText || "(No descriptor text returned by API)";
      body.style.marginTop = "0.35rem";
      body.style.opacity = "0.9";
      body.style.fontSize = "0.95em";
      body.style.whiteSpace = "pre-wrap";
      body.style.lineHeight = "1.35";
      body.style.maxHeight = "4.2em";
      body.style.overflow = "hidden";

      left.appendChild(title);
      left.appendChild(meta);
      left.appendChild(body);

      const actions = document.createElement("div");
      actions.style.display = "flex";
      actions.style.gap = "0.5rem";
      actions.style.flexWrap = "wrap";
      actions.style.alignItems = "center";
      actions.style.paddingTop = "0.05rem";

      const btnText = document.createElement("button");
      btnText.type = "button";
      btnText.className = "btn-secondary";
      btnText.textContent = "Insert text";
      btnText.onclick = (e) => {
        e.stopPropagation();
        insertTextAtCursor(d.rendered_text || d.text || d.title || "");
      };

      const btnToken = document.createElement("button");
      btnToken.type = "button";
      btnToken.className = "btn-secondary";
      btnToken.textContent = "Insert token";
      btnToken.onclick = (e) => {
        e.stopPropagation();
        insertTextAtCursor(buildTokenForId(d.id));
      };

      actions.appendChild(btnText);
      actions.appendChild(btnToken);

      row.appendChild(left);
      row.appendChild(actions);

      resultsEl.appendChild(row);
    });
  }

  async function refreshModalDescriptors() {
    if (!resultsEl) return;

    setModalStatus("Loading…");
    resultsEl.innerHTML = "<div style=\"opacity:0.7; padding:0.75rem;\">Loading descriptors…</div>";

    try {
      const url = buildModalListUrl();
      const data = await fetchJson(url);
      const items = Array.isArray(data) ? data : [];
      setModalStatus(items.length ? (items.length + " found") : "No results");
      renderModalDescriptors(items);
    } catch (e) {
      setModalStatus("Failed to load");
      resultsEl.innerHTML = "<div style=\"opacity:0.8; padding:0.75rem;\">Could not load descriptors. Check that <code>/api/descriptors/list</code> is available.</div>";
    }
  }

  function debouncedModalRefresh() {
    clearTimeout(_modalTimer);
    _modalTimer = setTimeout(() => refreshModalDescriptors(), 250);
  }

  if (openBtn) openBtn.addEventListener("click", function () { showModal(); });
  if (closeBtn) closeBtn.addEventListener("click", function () { hideModal(); });
  if (backdrop) backdrop.addEventListener("click", function () { hideModal(); });

  document.addEventListener("keydown", function (e) {
    if (!modal || modal.style.display !== "block") return;
    if (e.key === "Escape") hideModal();
  });

  if (packSel) packSel.addEventListener("change", function () { refreshModalDescriptors(); });

  if (searchEl) {
    searchEl.addEventListener("input", function () { debouncedModalRefresh(); });
    searchEl.addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        e.preventDefault();
        refreshModalDescriptors();
      }
    });
  }

  if (searchBtn) searchBtn.addEventListener("click", function () { refreshModalDescriptors(); });

  // =========================
  // Existing Vision Draft + Enhance + Thumbnail logic
  // =========================
  if (btnGenerateDraft) {
    const dz = document.getElementById("visionDropZone");
    const fileInput = document.getElementById("visionFile");
    const preview = document.getElementById("visionPreview");
    const status = document.getElementById("visionStatus");
    const dropText = document.getElementById("visionDropText");

    function setStatus(msg) {
      if (status) status.textContent = msg || "";
    }

    function setPreview(file) {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (ev) {
        if (preview) {
          preview.src = ev.target.result;
          preview.style.display = "block";
        }
        if (dropText) dropText.style.display = "none";
      };
      reader.readAsDataURL(file);
    }

    async function readResponseAsJsonOrText(resp) {
      const ct = (resp.headers && resp.headers.get) ? (resp.headers.get("content-type") || "") : "";
      if (ct.toLowerCase().indexOf("application/json") !== -1) {
        return { kind: "json", data: await resp.json() };
      }
      const txt = await resp.text();
      return { kind: "text", data: txt };
    }

    if (dz && fileInput) {
      dz.addEventListener("click", function () { fileInput.click(); });

      dz.addEventListener("dragover", function (e) {
        e.preventDefault();
        dz.style.borderColor = "#00bfff";
      });

      dz.addEventListener("dragleave", function (e) {
        e.preventDefault();
        dz.style.borderColor = "#444";
      });

      dz.addEventListener("drop", function (e) {
        e.preventDefault();
        dz.style.borderColor = "#444";
        const f = e.dataTransfer.files && e.dataTransfer.files[0];
        if (!f) return;
        if (!f.type.startsWith("image/")) { alert("Not an image file"); return; }
        fileInput.files = e.dataTransfer.files;
        setPreview(f);
      });

      fileInput.addEventListener("change", function () {
        const f = fileInput.files && fileInput.files[0];
        if (!f) return;
        setPreview(f);
      });
    }

    btnGenerateDraft.addEventListener("click", async function () {
      const f = fileInput && fileInput.files && fileInput.files[0];
      if (!f) {
        alert("Please upload an image first.");
        return;
      }

      btnGenerateDraft.disabled = true;
      const oldText = btnGenerateDraft.textContent;
      btnGenerateDraft.textContent = "Generating...";
      setStatus("Sending to Ollama...");

      try {
        const formData = new FormData();
        formData.append("image", f);
        formData.append("file", f);
        formData.append("vision_model", (document.getElementById("visionModel") || {}).value || "");
        formData.append("text_model", (document.getElementById("textModel") || {}).value || "");
        formData.append("vision_instruction", (document.getElementById("customVisionInstruction") || {}).value || "");
        formData.append("draft_instruction", (document.getElementById("customDraftInstruction") || {}).value || "");

        const r = await fetch("/api/generate_prompt_from_image", {
          method: "POST",
          body: formData
        });

        const parsed = await readResponseAsJsonOrText(r);

        if (!r.ok) {
          if (parsed.kind === "json" && parsed.data && parsed.data.error) {
            setStatus("Error (" + r.status + "): " + parsed.data.error);
          } else if (parsed.kind === "json") {
            setStatus("Error (" + r.status + "): Request failed.");
          } else {
            const snippet = (parsed.data || "").toString().replace(/\s+/g, " ").slice(0, 180);
            setStatus("Error (" + r.status + "): " + snippet);
          }
          return;
        }

        if (parsed.kind !== "json") {
          const snippet2 = (parsed.data || "").toString().replace(/\s+/g, " ").slice(0, 180);
          setStatus("Error: Non-JSON response: " + snippet2);
          return;
        }

        const data = parsed.data;

        if (data && data.error) {
          setStatus("Error: " + data.error);
        } else {
          setStatus("Success!");
          const ta = document.getElementById("content");
          if (ta && data && data.content) ta.value = data.content;

          if (data && data.thumbnail_url) {
            const mainPreview = document.getElementById("mainThumbPreview");
            const mainPlaceholder = document.getElementById("mainThumbPlaceholder");
            const hiddenThumb = document.getElementById("hiddenThumb");
            if (mainPreview) {
              mainPreview.src = data.thumbnail_url;
              mainPreview.style.display = "block";
            }
            if (mainPlaceholder) mainPlaceholder.style.display = "none";
            if (hiddenThumb && data.thumbnail_path) hiddenThumb.value = data.thumbnail_path;
          }
        }
      } catch (e) {
        setStatus("Network Error: " + (e && e.message ? e.message : "Request failed"));
        console.error(e);
      } finally {
        btnGenerateDraft.disabled = false;
        btnGenerateDraft.textContent = oldText;
      }
    });
  }

  const btnToggle = document.getElementById("btnToggleRefine");
  if (btnToggle) {
    const refineTools = document.getElementById("refineTools");
    const btnRun = document.getElementById("btnRunRefine");
    const contentArea = document.getElementById("content");
    const refineStatus = document.getElementById("refineStatus");

    btnToggle.addEventListener("click", function () {
      if (!refineTools) return;
      refineTools.style.display = (refineTools.style.display === "none" || !refineTools.style.display) ? "block" : "none";
    });

    if (btnRun) {
      btnRun.addEventListener("click", async function () {
        const originalText = (contentArea && contentArea.value || "").trim();
        if (!originalText) {
          alert("Please enter some text to refine first.");
          return;
        }

        btnRun.disabled = true;
        const oldText = btnRun.textContent;
        btnRun.textContent = "Running...";
        if (refineStatus) refineStatus.textContent = "Sending to Ollama...";

        try {
          const response = await fetch("/api/generate_refinement", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              content: originalText,
              model: (document.getElementById("quickRefineModel") || {}).value || "",
              instruction: (document.getElementById("quickRefineInstruction") || {}).value || "",
              system_role: (document.getElementById("quickRefineSystem") || {}).value || ""
            })
          });

          const data = await response.json();

          if (data && data.error) {
            if (refineStatus) refineStatus.textContent = "Error: " + data.error;
          } else {
            if (refineStatus) refineStatus.textContent = "Success!";
            if (contentArea && data && data.content) contentArea.value = data.content;
          }
        } catch (e) {
          if (refineStatus) refineStatus.textContent = "Network Error.";
          console.error(e);
        } finally {
          btnRun.disabled = false;
          btnRun.textContent = oldText;
        }
      });
    }
  }

  const mainDropZone = document.getElementById("mainThumbDropZone");
  const mainInput = document.getElementById("mainThumbInput");
  const mainPreview = document.getElementById("mainThumbPreview");
  const mainPlaceholder = document.getElementById("mainThumbPlaceholder");
  const hiddenThumbPath = document.getElementById("hiddenThumb");
  const promptIdStr = (document.getElementById("jsPromptId") || {}).value || "";
  const currentPromptId = promptIdStr ? parseInt(promptIdStr, 10) : null;

  if (mainDropZone) {
    mainDropZone.addEventListener("dragover", function (e) {
      e.preventDefault();
      mainDropZone.style.borderColor = "#00bfff";
    });

    mainDropZone.addEventListener("dragleave", function (e) {
      e.preventDefault();
      mainDropZone.style.borderColor = "#444";
    });

    mainDropZone.addEventListener("drop", function (e) {
      e.preventDefault();
      mainDropZone.style.borderColor = "#444";

      if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
        const file = e.dataTransfer.files[0];
        if (!file.type.startsWith("image/")) { alert("Not an image file"); return; }

        if (currentPromptId) {
          const formData = new FormData();
          formData.append("file", file);

          fetch("/api/prompt/" + currentPromptId + "/upload_thumb", { method: "POST", body: formData })
            .then(r => r.json())
            .then(data => {
              if (data && data.success) {
                if (mainPreview) {
                  mainPreview.src = data.thumbnail_url;
                  mainPreview.style.display = "block";
                }
                if (mainPlaceholder) mainPlaceholder.style.display = "none";
                if (hiddenThumbPath) hiddenThumbPath.value = data.thumbnail_path;
              } else {
                alert((data && data.error) ? data.error : "Upload failed");
              }
            })
            .catch(e2 => console.error(e2));
        } else if (mainInput) {
          mainInput.files = e.dataTransfer.files;
          const reader = new FileReader();
          reader.onload = function (ev) {
            if (mainPreview) {
              mainPreview.src = ev.target.result;
              mainPreview.style.display = "block";
            }
            if (mainPlaceholder) mainPlaceholder.style.display = "none";
          };
          reader.readAsDataURL(file);
        }
      }
    });
  }
})();
</script>

{% endblock %}
