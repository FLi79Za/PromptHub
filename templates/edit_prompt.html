{% extends "base.html" %}

{% block content %}
<section class="page">
  <div class="page-header" style="display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap;">
    <div>
      <h2 style="margin:0;">
        {% if prompt and prompt.id %}Edit Prompt{% else %}New Prompt{% endif %}
      </h2>
      {% if prompt %}
        {% if parent %}
           <div style="font-size:0.9rem; margin-top:0.25rem;">
              ↳ Variant of <a href="{{ url_for('edit_prompt', prompt_id=parent.id) }}" style="color:#00bfff;">{{ parent.title }}</a>
           </div>
        {% endif %}
      {% endif %}
    </div>

    <div style="display:flex; gap:.5rem; align-items:center; flex-wrap:wrap;">
      {% if prompt and prompt.id %}
        <a class="btn-secondary" href="{{ url_for('render_prompt', prompt_id=prompt.id) }}">Use</a>
        
        <form method="post" action="{{ url_for('duplicate_prompt', prompt_id=prompt.id) }}" style="display:inline;">
          <button class="btn-secondary" type="submit">Copy</button>
        </form>

        <button class="btn-secondary" type="submit" 
                form="mainPromptForm" 
                formaction="{{ url_for('duplicate_prompt', prompt_id=prompt.id) }}" 
                name="as_variant" value="true"
                title="Create a child version linked to this prompt using your current edits">Make Variant</button>
      {% endif %}
      <a class="btn-secondary" href="{{ url_for('index') }}">Back</a>
    </div>
  </div>

  {% if not prompt or not prompt.id %}
    {% if ollama_models %}
    <details style="background:#1a1a1a; padding:1rem; border-radius:8px; margin-bottom:1.5rem; border:1px solid #333;">
        <summary style="cursor:pointer; font-weight:bold; color:#00bfff;">✨ Generate Draft Prompt from Image (Vision)</summary>
        
        <div style="margin-top:1rem; display:grid; grid-template-columns: 1fr 1fr; gap:1.5rem;">
            
            <div>
                <label style="margin-bottom:0.5rem; display:block;">Reference Image</label>
                <div id="visionDropZone" class="drop-zone" style="border:2px dashed #444; padding:2rem; text-align:center; border-radius:8px; cursor:pointer; background:#111;">
                    <div id="visionDropText" style="color:#888;">
                        Drag image here or click to upload
                    </div>
                    <input type="file" id="visionFile" accept="image/*" style="display:none;">
                    <img id="visionPreview" style="max-width:100%; max-height:200px; margin-top:1rem; display:none; border-radius:4px;">
                </div>
            </div>

            <div style="display:flex; flex-direction:column; gap:1rem;">
               <div style="display:grid; grid-template-columns: 1fr 1fr; gap:1rem;">
                   <div>
                       <label>Vision Model</label>
                       <select id="visionModel" style="width:100%;">
                           {% for m in ollama_models %}
                               <option value="{{ m }}" {% if 'llava' in m or 'vision' in m or 'qwen' in m %}selected{% endif %}>{{ m }}</option>
                           {% endfor %}
                       </select>
                   </div>
                   <div>
                       <label>Text Model</label>
                       <select id="textModel" style="width:100%;">
                           {% for m in ollama_models %}
                               <option value="{{ m }}">{{ m }}</option>
                           {% endfor %}
                       </select>
                   </div>
               </div>

               <div>
                   <label>Vision Instructions (Optional)</label>
                   <textarea id="customVisionInstruction" rows="2" placeholder="Tell the vision model what to look for (e.g. 'Describe lighting details')" style="width:100%; font-size:0.9em;"></textarea>
               </div>

               <div>
                   <label>Drafting Instructions (Optional)</label>
                   <textarea id="customDraftInstruction" rows="2" placeholder="Tell the text model how to write (e.g. 'Use colourful, poetic language')" style="width:100%; font-size:0.9em;"></textarea>
               </div>

               <div id="visionStatus" style="font-size:0.9em; color:#888; min-height:1.2em;"></div>
               
               <button type="button" id="btnGenerateDraft" class="btn-primary" style="margin-top:auto;">Generate Draft & Set Thumbnail</button>
            </div>
        </div>
    </details>
    {% endif %}
  {% endif %}

  <form method="post"
        id="mainPromptForm"
        {% if prompt and prompt.id %} action="{{ url_for('edit_prompt', prompt_id=prompt.id) }}"
        {% else %} action="{{ url_for('new_prompt') }}" {% endif %}
        enctype="multipart/form-data" class="form">

    <input type="hidden" name="hidden_thumbnail_path" id="hiddenThumb">

    <div class="grid-2">
      <div>
        <label>Title</label>
        <input type="text" name="title" value="{{ prompt.title if prompt else '' }}" required>
      </div>
      <div>
        <label>Prompt Type</label>
        <select name="prompt_type" required>
          {% for pt in prompt_types %}
            <option value="{{ pt }}" {% if prompt and prompt.prompt_type == pt %}selected{% endif %}>{{ pt }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <div class="grid-2">
      <div>
        <label>Category</label>
        <input list="category_list" name="category" value="{{ prompt.category if prompt else '' }}" placeholder="Select or type new..." autocomplete="off" required>
        <datalist id="category_list">
          {% for c in categories %}
            <option value="{{ c }}">
          {% endfor %}
        </datalist>
      </div>
      <div>
        <label>Tool</label>
        <input list="tool_list" name="tool" value="{{ prompt.tool if prompt else '' }}" placeholder="Select or type new..." autocomplete="off" required>
        <datalist id="tool_list">
          {% for t in tools %}
            <option value="{{ t }}">
          {% endfor %}
        </datalist>
      </div>
    </div>

    <div>
      <label>Tags (comma separated)</label>
      <input type="text" name="tags" value="{{ tags_str }}" placeholder="e.g. Portrait, Realistic, Sci-Fi, Dark">
    </div>

    <div>
      <div style="display:flex; justify-content:space-between; align-items:end; margin-bottom:0.5rem;">
          <label style="margin-bottom:0;">Prompt Content</label>
          
          {% if ollama_models %}
          <div style="font-size:0.85rem; display:flex; gap:0.5rem; align-items:center;">
              <select id="quickRefineModel" style="padding:0.2rem; max-width:150px;">
                  {% for m in ollama_models %}
                    <option value="{{ m }}" {% if session.get('ollama_model') == m %}selected{% endif %}>{{ m }}</option>
                  {% endfor %}
              </select>
              <button type="button" id="btnToggleRefine" class="btn-secondary" style="padding:0.2rem 0.6rem; font-size:0.85rem;">✨ Enhance...</button>
          </div>
          {% endif %}
      </div>

      <div id="refineTools" style="display:none; background:#222; padding:0.75rem; border-radius:4px; margin-bottom:0.5rem; border:1px solid #444;">
          <div style="display:flex; flex-direction:column; gap:0.5rem;">
              
              <div>
                  <label style="font-size:0.75em; color:#888; display:block; margin-bottom:0.2rem;">System Role (Persona)</label>
                  <input type="text" id="quickRefineSystem" value="You are an expert prompt engineer. Output ONLY the refined prompt text." style="font-size:0.85rem; width:100%; color:#aaa; background:#111; border:1px solid #333;">
              </div>

              <div>
                   <label style="font-size:0.75em; color:#888; display:block; margin-bottom:0.2rem;">Instruction</label>
                   <div style="display:grid; grid-template-columns: 1fr auto; gap:0.5rem;">
                      <input type="text" id="quickRefineInstruction" placeholder="e.g. 'Add cinematic lighting' or 'Make it spooky'" style="font-size:0.9rem;">
                      <button type="button" id="btnRunRefine" class="btn-primary" style="padding:0.4rem 1rem; font-size:0.9rem;">Run</button>
                   </div>
              </div>
          </div>

          <div style="margin-top:0.5rem; font-size:0.8em; color:#888; display:flex; justify-content:space-between;">
             <span>Updates text below.</span>
             <span id="refineStatus" style="color:#00bfff;"></span>
          </div>
      </div>

      <textarea name="content" id="content" rows="10" required style="width:100%;">{{ prompt.content if prompt else '' }}</textarea>
    </div>

    <div>
      <label>Notes</label>
      <textarea name="notes" id="notes" rows="4">{{ prompt.notes if prompt and prompt.notes else '' }}</textarea>
    </div>

    <div>
        <label id="mainThumbLabel">Thumbnail (optional)</label>
        <input type="file" name="thumbnail" accept="image/*">
        
        <div style="margin-top:0.75rem; padding: 0.5rem; border: 1px solid #333; border-radius: 4px; display: inline-block;">
             <img id="mainThumbPreview" 
                  src="{{ url_for('static', filename=prompt.thumbnail) if prompt and prompt.thumbnail else '' }}" 
                  style="max-height: 120px; border-radius: 4px; display: {% if prompt and prompt.thumbnail %}block{% else %}none{% endif %};">
             
             {% if prompt and prompt.thumbnail %}
                 <label style="font-weight: normal; font-size: 0.9em; display:flex; align-items:center; margin-top: 0.5rem;">
                   <input type="checkbox" name="remove_thumbnail" style="margin-right: 0.5rem;"> Remove
                 </label>
             {% endif %}
        </div>
    </div>

    {% if variants and variants|length > 0 %}
      <div style="background:#1a1a1a; padding:1rem; border-radius:8px; margin-top:1rem;">
         <h4 style="margin-top:0;">Variants</h4>
         <ul style="margin:0; padding-left:1.5rem;">
           {% for v in variants %}
             <li><a href="{{ url_for('edit_prompt', prompt_id=v.id) }}" style="color:#00bfff;">{{ v.title }}</a></li>
           {% endfor %}
         </ul>
      </div>
    {% endif %}

    <div style="display:flex; gap:.75rem; align-items:center; flex-wrap:wrap; margin-top:1.5rem;">
      <button type="submit">Save</button>
      {% if prompt and prompt.id %}
        <a class="btn-secondary" href="{{ url_for('refine_prompt', prompt_id=prompt.id) }}">Refine with Ollama</a>
      {% endif %}
    </div>
  </form>
</section>

<script>
document.addEventListener('DOMContentLoaded', () => {
    
    // ==========================================
    // 1. VISION / IMAGE UPLOAD LOGIC (Independent)
    // ==========================================
    const dropZone = document.getElementById('visionDropZone');
    if (dropZone) {
        const fileInput = document.getElementById('visionFile');
        const preview = document.getElementById('visionPreview');
        const dropText = document.getElementById('visionDropText');
        const btn = document.getElementById('btnGenerateDraft');
        const statusDiv = document.getElementById('visionStatus');
        const contentBox = document.getElementById('content');

        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => {
            if(fileInput.files.length) showPreview(fileInput.files[0]);
        });
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault(); dropZone.style.borderColor = '#00bfff';
        });
        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault(); dropZone.style.borderColor = '#444';
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault(); dropZone.style.borderColor = '#444';
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files; 
                showPreview(e.dataTransfer.files[0]);
            }
        });

        function showPreview(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                preview.src = e.target.result;
                preview.style.display = 'block';
                dropText.style.display = 'none';
            };
            reader.readAsDataURL(file);
        }

        btn.addEventListener('click', async () => {
            if (!fileInput.files.length) { alert("Select an image first."); return; }
            btn.disabled = true; btn.textContent = "Processing...";
            statusDiv.textContent = "Analyzing Image...";
            
            const formData = new FormData();
            formData.append('image', fileInput.files[0]);
            formData.append('vision_model', document.getElementById('visionModel').value);
            formData.append('text_model', document.getElementById('textModel').value);
            formData.append('custom_vision_instruction', document.getElementById('customVisionInstruction').value);
            formData.append('custom_draft_instruction', document.getElementById('customDraftInstruction').value);

            try {
                const response = await fetch('/api/generate_draft_from_image', { method: 'POST', body: formData });
                const data = await response.json();
                if (data.error) {
                    statusDiv.textContent = "Error: " + data.error;
                } else {
                    statusDiv.textContent = "Success!";
                    if (contentBox) contentBox.value = data.draft_prompt;
                    
                    if(data.thumbnail_path) {
                        const hiddenInput = document.getElementById('hiddenThumb');
                        if(hiddenInput) hiddenInput.value = data.thumbnail_path;
                        const mainThumbPreview = document.getElementById('mainThumbPreview');
                        if(mainThumbPreview) {
                            mainThumbPreview.src = "{{ url_for('static', filename='') }}" + data.thumbnail_path;
                            mainThumbPreview.style.display = 'block';
                        }
                    }
                }
            } catch (e) { alert("Error: " + e); } 
            finally { btn.disabled = false; btn.textContent = "Generate Draft"; }
        });
    }

    // ==========================================
    // 2. QUICK ENHANCE LOGIC (Independent)
    // ==========================================
    const btnToggle = document.getElementById('btnToggleRefine');
    
    if (btnToggle) {
        const refineTools = document.getElementById('refineTools');
        const btnRun = document.getElementById('btnRunRefine');
        const contentArea = document.getElementById('content');
        const refineStatus = document.getElementById('refineStatus');

        btnToggle.addEventListener('click', () => {
            // Toggle visibility
            if (refineTools.style.display === 'none') {
                refineTools.style.display = 'block';
            } else {
                refineTools.style.display = 'none';
            }
        });

        btnRun.addEventListener('click', async () => {
            const originalText = contentArea.value.trim();
            if (!originalText) {
                alert("Please enter some text to refine first.");
                return;
            }

            btnRun.disabled = true;
            btnRun.textContent = "Running...";
            refineStatus.textContent = "Sending to Ollama...";

            try {
                const response = await fetch('/api/generate_refinement', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: originalText,
                        model: document.getElementById('quickRefineModel').value,
                        instruction: document.getElementById('quickRefineInstruction').value,
                        system_role: document.getElementById('quickRefineSystem').value // <--- Sends the system role
                    })
                });

                const data = await response.json();

                if (data.error) {
                    refineStatus.textContent = "Error: " + data.error;
                } else {
                    refineStatus.textContent = "Success!";
                    contentArea.value = data.content; 
                }
            } catch (e) {
                refineStatus.textContent = "Network Error.";
                console.error(e);
            } finally {
                btnRun.disabled = false;
                btnRun.textContent = "Run";
            }
        });
    }
});
</script>
{% endblock %}